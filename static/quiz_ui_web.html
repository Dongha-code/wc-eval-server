<!-- μƒλµ: <head>, <style> λ° κΈ°μ΅΄ κµ¬μ΅° μ μ§€ -->

<script>
  // ... (κΈ°μ΅΄ μ½”λ“ μƒλµ)

  async function submitAnswer() {
    const answer = document.getElementById("answer").value.trim();
    if (!answer) return alert("λ‹µλ³€μ„ μ…λ ¥ν•μ„Έμ”.");

    const submitBtn = document.getElementById("submit-button");
    submitBtn.disabled = true;
    submitBtn.innerText = "μ μ¶ μ¤‘...";
    document.getElementById("status").innerText = "β³ GPTκ°€ λ‹µλ³€μ„ ν‰κ°€ν•κ³  μμµλ‹λ‹¤...";

    const res = await fetch("/api/submit-answer", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ email, answer })
    });

    const data = await res.json();
    if (data.error) {
      document.getElementById("status").innerText = "β οΈ μ¤λ¥ λ°μƒ: " + data.error;
      submitBtn.innerText = "λ‹¤μ λ¬Έν•­";
      submitBtn.disabled = false;
    } else if (data.complete) {
      // π‘‡ μ§„λ‹¨ μ™„λ£ μ‹ UIλ¥Ό μ¨κΈ°κ³  κ²°κ³Όλ§ ν‘μ‹
      document.getElementById("quiz-area").style.display = "none";
      document.getElementById("status").style.display = "none";

      // κ²°κ³Ό μ”μ•½ ν‘μ‹
      showReport();
    } else {
      await loadNextQuestion();
    }
  }

  async function showReport() {
    const res = await fetch(`/api/report?email=${encodeURIComponent(email)}`);
    const report = await res.json();

    const all = report.answers;
    const scores = all.map(r => r.feedback?.score || 0);
    const avg = Math.round(scores.reduce((a, b) => a + b, 0) / scores.length);
    const min = Math.min(...scores);
    const max = Math.max(...scores);
    const level = all[all.length - 1].feedback?.level || "-";

    const lowestSteps = all
      .map(r => ({ step: r.step, score: r.feedback?.score || 0 }))
      .sort((a, b) => a.score - b.score)
      .slice(0, 3)
      .map(r => r.step);

    const summaryHTML = `
      <h3>π‰ λ¨λ“  λ¬Έν•­μ„ μ™„λ£ν•μ…¨μµλ‹λ‹¤!</h3>
      <p>β… μ§„λ‹¨ κ²°κ³Ό μ μ¶ μ™„λ£ (${all.length}λ¬Έν•­).</p>
      <p>μ΄λ¦„: ${report.name}</p>
      <p>μ΄λ©”μΌ: ${report.email}</p>
      <br />
      <p>π“ μ΄ λ¬Έν•­ μ: ${all.length}</p>
      <p>π§® ν‰κ·  μ μ: ${avg}μ </p>
      <p>π“ μµκ³ /μµμ € μ μ: ${max}μ  / ${min}μ </p>
      <p>π― ν‰κ°€ μμ¤€: <strong>${level}</strong></p>
      <p>π“ λ³µμµ μ¶”μ² STEP: ${[...new Set(lowestSteps)].join(", ")}</p>
    `;

    const summary = document.getElementById("summary");
    summary.innerHTML = summaryHTML;
    summary.style.display = "block";
  }
</script>
