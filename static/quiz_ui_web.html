<!-- 생략: <head>, <style> 및 기존 구조 유지 -->

<script>
  // ... (기존 코드 생략)

  async function submitAnswer() {
    const answer = document.getElementById("answer").value.trim();
    if (!answer) return alert("답변을 입력하세요.");

    const submitBtn = document.getElementById("submit-button");
    submitBtn.disabled = true;
    submitBtn.innerText = "제출 중...";
    document.getElementById("status").innerText = "⏳ GPT가 답변을 평가하고 있습니다...";

    const res = await fetch("/api/submit-answer", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ email, answer })
    });

    const data = await res.json();
    if (data.error) {
      document.getElementById("status").innerText = "⚠️ 오류 발생: " + data.error;
      submitBtn.innerText = "다음 문항";
      submitBtn.disabled = false;
    } else if (data.complete) {
      // 👇 진단 완료 시 UI를 숨기고 결과만 표시
      document.getElementById("quiz-area").style.display = "none";
      document.getElementById("status").style.display = "none";

      // 결과 요약 표시
      showReport();
    } else {
      await loadNextQuestion();
    }
  }

  async function showReport() {
    const res = await fetch(`/api/report?email=${encodeURIComponent(email)}`);
    const report = await res.json();

    const all = report.answers;
    const scores = all.map(r => r.feedback?.score || 0);
    const avg = Math.round(scores.reduce((a, b) => a + b, 0) / scores.length);
    const min = Math.min(...scores);
    const max = Math.max(...scores);
    const level = all[all.length - 1].feedback?.level || "-";

    const lowestSteps = all
      .map(r => ({ step: r.step, score: r.feedback?.score || 0 }))
      .sort((a, b) => a.score - b.score)
      .slice(0, 3)
      .map(r => r.step);

    const summaryHTML = `
      <h3>🎉 모든 문항을 완료하셨습니다!</h3>
      <p>✅ 진단 결과 제출 완료 (${all.length}문항).</p>
      <p>이름: ${report.name}</p>
      <p>이메일: ${report.email}</p>
      <br />
      <p>📊 총 문항 수: ${all.length}</p>
      <p>🧮 평균 점수: ${avg}점</p>
      <p>📈 최고/최저 점수: ${max}점 / ${min}점</p>
      <p>🎯 평가 수준: <strong>${level}</strong></p>
      <p>📌 복습 추천 STEP: ${[...new Set(lowestSteps)].join(", ")}</p>
    `;

    const summary = document.getElementById("summary");
    summary.innerHTML = summaryHTML;
    summary.style.display = "block";
  }
</script>
