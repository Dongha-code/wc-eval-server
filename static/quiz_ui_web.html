<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>WiseCollector 2.0 ν•™μµ μ§„λ‹¨</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100 text-gray-800">
  <div class="min-h-screen flex items-center justify-center p-4">
    <div class="w-full max-w-3xl bg-white p-8 rounded-xl shadow-md space-y-6" id="main-container">
      <div>
        <h1 class="text-2xl font-bold text-gray-900 mb-2">WiseCollector 2.0 μ΄μ & ν”„λ΅μ‹ ν•™μµ μ§„λ‹¨</h1>
        <p class="text-sm text-gray-500">β± μμƒ μ†μ” μ‹κ°„: μ•½ 60λ¶„ (μ΄ 30λ¬Έν•­)</p>
      </div>

      <div id="quiz-container">
        <p id="progress" class="text-sm text-gray-600 mb-1"></p>
        <p id="step-indicator" class="text-sm text-blue-600 font-medium"></p>
        <p id="question" class="mt-2 whitespace-pre-line"></p>

        <textarea id="answer" rows="4" class="mt-4 w-full border border-gray-300 rounded-md p-2" placeholder="μ—¬κΈ°μ— λ‹µλ³€μ„ μ…λ ¥ν•μ„Έμ”"></textarea>
        <button id="next-btn" class="w-full mt-4 bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-md disabled:opacity-50" disabled>
          λ‹¤μ λ¬Έν•­
        </button>
        <p id="status" class="text-sm text-gray-500 mt-2"></p>
      </div>

      <div id="result-container" class="hidden bg-gray-50 p-6 rounded-lg">
        <h2 class="text-xl font-bold text-red-600 mb-4">π‰ λ¨λ“  λ¬Έν•­μ„ μ™„λ£ν•μ…¨μµλ‹λ‹¤!</h2>
        <p class="text-sm text-gray-700 mb-1"><strong>β… μ§„λ‹¨ κ²°κ³Ό μ μ¶ μ™„λ£ (30λ¬Έν•­).</strong></p>
        <p class="text-sm text-gray-700 mb-1" id="result-name"></p>
        <p class="text-sm text-gray-700 mb-4" id="result-email"></p>
        <ul class="space-y-2 text-sm text-gray-700">
          <li>π“ μ΄ λ¬Έν•­ μ: <span id="result-total"></span></li>
          <li>π§® ν‰κ·  μ μ: <span id="result-avg"></span></li>
          <li>π“ μµκ³ /μµμ € μ μ: <span id="result-max-min"></span></li>
          <li>π― ν‰κ°€ μμ¤€: <span id="result-level" class="font-bold text-red-500"></span></li>
          <li>π“ λ³µμµ μ¶”μ² STEP: <span id="result-review-steps"></span></li>
        </ul>
      </div>
    </div>
  </div>

  <script>
    const stepIndicator = document.getElementById("step-indicator");
    const progress = document.getElementById("progress");
    const question = document.getElementById("question");
    const answerInput = document.getElementById("answer");
    const nextBtn = document.getElementById("next-btn");
    const statusText = document.getElementById("status");
    const resultContainer = document.getElementById("result-container");
    const quizContainer = document.getElementById("quiz-container");

    let currentQuestion = 0;
    let totalQuestions = 30;
    let questions = [];
    let stepSequence = [];

    let userName = "";
    let userEmail = "";

    async function fetchNextQuestion() {
      nextBtn.disabled = true;
      statusText.textContent = "π“΅ λ¬Έμ λ¥Ό λ¶λ¬μ¤λ” μ¤‘μ…λ‹λ‹¤...";
      const response = await fetch("/api/next-question");
      const data = await response.json();
      if (data && data.question) {
        questions.push(data.question);
        stepSequence.push(data.step || "STEP ?");
        currentQuestion = questions.length;
        updateUI();
      }
      nextBtn.disabled = false;
      statusText.textContent = "";
    }

    function updateUI() {
      progress.textContent = `(${currentQuestion}/30)`;
      stepIndicator.innerHTML = `π” ν•™μµ λ²”μ„: <span class="font-semibold text-blue-500">${stepSequence[currentQuestion - 1]}</span>`;
      question.textContent = questions[currentQuestion - 1] || "";
      answerInput.value = "";
      answerInput.focus();
    }

    async function submitAnswer() {
      const answer = answerInput.value.trim();
      if (!answer) return;
      nextBtn.disabled = true;
      statusText.textContent = "λ‹µμ•μ„ μ μ¶ μ¤‘μ…λ‹λ‹¤...";

      const payload = {
        answer,
        question: questions[currentQuestion - 1],
        step: stepSequence[currentQuestion - 1],
        name: userName,
        email: userEmail,
      };

      await fetch("/api/submit-answer", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });

      if (currentQuestion >= totalQuestions) {
        showResult();
      } else {
        await fetchNextQuestion();
      }
    }

    function showResult() {
      quizContainer.classList.add("hidden");
      resultContainer.classList.remove("hidden");

      document.getElementById("result-name").textContent = `μ΄λ¦„: ${userName}`;
      document.getElementById("result-email").textContent = `μ΄λ©”μΌ: ${userEmail}`;

      fetch("/api/result-summary")
        .then(res => res.json())
        .then(summary => {
          document.getElementById("result-total").textContent = summary.total || "30";
          document.getElementById("result-avg").textContent = `${summary.averageScore || 0}μ `;
          document.getElementById("result-max-min").textContent = `${summary.max || 100}μ  / ${summary.min || 0}μ `;
          document.getElementById("result-level").textContent = summary.level || "N/A";
          document.getElementById("result-review-steps").textContent = summary.recommendedSteps || "-";
        });
    }

    nextBtn.addEventListener("click", submitAnswer);

    window.onload = async () => {
      userName = prompt("μ΄λ¦„μ„ μ…λ ¥ν•μ„Έμ”:");
      userEmail = prompt("μ΄λ©”μΌμ„ μ…λ ¥ν•μ„Έμ”:");
      await fetchNextQuestion();
    };
  </script>
</body>
</html>
